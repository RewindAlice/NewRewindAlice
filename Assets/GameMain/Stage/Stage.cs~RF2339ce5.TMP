using UnityEngine;
using System.Collections;
using System.Collections.Generic;   // 動的配列で使用

using System.IO;    // ファイル入出力
using System.Text;  //

public class Stage : MonoBehaviour
{
    const int STAGE_X = 11; // ステージの横幅
    const int STAGE_Y = 5;  // ステージの高さ
    const int STAGE_Z = 11; // ステージの奥行

    // ステージギミック番号
    const int NONE = 1;     // 何も無い
    const int START = 2;    // スタート地点
    const int GOAL = 3;     // ゴール地点
    const int BLOCK = 4;    // ブロック
    const int ENEMY = 5;    // 敵

    public GameObject gimmickNone;  // 何も無い
    public GameObject gimmickStart; // スタート地点
    public GameObject gimmickGoal;  // ゴール地点
    public GameObject gimmickBlock; // ブロック
    public GameObject gimmickEnemy; // 敵

    int gimmick = 0;            // 配列の数字
    int gimmickPattern = 0;     // ギミックの種類
    int gimmickDirection = 0;   // ギミックの向き
    int gimmickStartTurn = 0;   // ギミックの開始ターン

    int[, ,] gimmickNumArray = new int[STAGE_Y, STAGE_X, STAGE_Z];                  // ステージの配置（数字）
    List<int> moveGimmickNumList = new List<int>();                                 // 移動系ギミック（数字）
    GameObject[, ,] gimmickObjectArray = new GameObject[STAGE_Y, STAGE_X, STAGE_Z]; // ステージの配置（オブジェクト）
    List<GameObject> moveGimmickObjectList = new List<GameObject>();                // 移動系ギミック（オブジェクト）
    int[, ,] gimmickStartTurnArray = new int[STAGE_Y, STAGE_X, STAGE_Z];            // ステージの配置（開始ターン数）
    List<int> moveGimmickStartTurnList = new List<int>();                           // 移動系ギミック（開始ターン数）
    int turnNum;                                                                    // ステージのターン数

	// 初期化
	void Start ()
    {
        
	}
	
	// 更新
	void Update ()
    {
	
	}

    // ステージの生成
    public void CreateStage()
    {
        for(int x = 0; x < STAGE_X; x++)
        {
            for(int y = 0; y < STAGE_Y; y++)
            {
                for(int z = 0; z < STAGE_Z; z++)
                {
                    // ギミックの生成
                    CreateGimmcik(x, y, z);
                }
            }
        }
    }

    // ギミックの生成
    public void CreateGimmcik(int x, int y, int z)
    {
        gimmick = 0;            // 配列の数字（一時保存用）
        gimmickPattern = 0;     // ギミックの種類
        gimmickDirection = 0;   // ギミックの向き
        gimmickStartTurn = 0;   // ギミックの開始ターン

        gimmick = gimmickNumArray[y, x, z]; // 配列の数字を一時的に保存する
        gimmickDirection = gimmick / 10000; // 配列の数字を一万で割りギミックの向きを求める
        gimmick = gimmick % 10000;          // 配列の数字を一万で割った余りを入れる
        gimmickPattern = gimmick / 100;     // 配列の数字を百で割りギミックの種類を求める
        gimmick = gimmick % 100;            // 配列の数字を百で割った余りを入れる
        gimmickStartTurn = gimmick;         // ギミックの開始ターンを入れる

        switch (gimmickPattern)
        {
            case NONE:  // 何も無い////////////////////////////////////////////////////////////////////////////////////////////////////////
                gimmickObjectArray[y, x, z] = GameObject.Instantiate(gimmickNone, new Vector3(x, y, z), Quaternion.identity) as GameObject;
                gimmickObjectArray[y, x, z].transform.localEulerAngles = getGimmickDirection(gimmickDirection);
                gimmickStartTurnArray[y, x, z] = gimmickStartTurn;
                break;
            case START: // スタート地点/////////////////////////////////////////////////////////////////////////////////////////////////////
                gimmickObjectArray[y, x, z] = GameObject.Instantiate(gimmickStart, new Vector3(x, y, z), Quaternion.identity) as GameObject;
                gimmickObjectArray[y, x, z].transform.localEulerAngles = getGimmickDirection(gimmickDirection);
                gimmickStartTurnArray[y, x, z] = gimmickStartTurn;
                break;
            case GOAL:  // ゴール地点//////////////////////////////////////////////////////////////////////////////////////////////////////
                gimmickObjectArray[y, x, z] = GameObject.Instantiate(gimmickGoal, new Vector3(x, y, z), Quaternion.identity) as GameObject;
                gimmickObjectArray[y, x, z].transform.localEulerAngles = getGimmickDirection(gimmickDirection);
                gimmickStartTurnArray[y, x, z] = gimmickStartTurn;
                break;
            case BLOCK: // ブロック/////////////////////////////////////////////////////////////////////////////////////////////////////////
                gimmickObjectArray[y, x, z] = GameObject.Instantiate(gimmickBlock, new Vector3(x, y, z), Quaternion.identity) as GameObject;
                gimmickObjectArray[y, x, z].transform.localEulerAngles = getGimmickDirection(gimmickDirection);
                gimmickStartTurnArray[y, x, z] = gimmickStartTurn;
                break;
            //case ENEMY: // 敵//////////////////////////////////////////////////////////////////////////////////////////////////////////////
            //    gimmickObjectArray[y, x, z] = GameObject.Instantiate(gimmickNone, new Vector3(x, y, z), Quaternion.identity) as GameObject;
            //    gimmickStartTurnArray[y, x, z] = 1;
            //    gimmickNumArray[y, x, z] = NONE;
            //    moveGimmickObjectList.Add(GameObject.Instantiate(gimmickEnemy, new Vector3(x, y, z), Quaternion.identity) as GameObject);
            //    moveGimmickStartTurnList.Add(gimmickNumArray[y, x, z] % 100);
            //    moveGimmickNumList.Add(ENEMY);
            //    break;
        }
    }

    // 選択されたステージを設定
    public void setSelectStage(int stageNum)
    {
        switch(stageNum)
        {
            case 1: Stage1(); break;
        }
    }

    // ステージ１
    public void Stage1()
    {
        int stageTurnNum = 5;

        int[, ,] stage = new int[,,]
        {
            {
                // １段目
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10401,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
            },
            {
                // ２段目
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  20201,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
            },
            {
                // ３段目
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
            },
            {
                // ４段目
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
            },
            {
                // ５段目
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
                {  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101,  10101},
            },
        };

        turnNum = stageTurnNum;

        for (int x = 0; x < STAGE_X; x++)
        {
            for (int y = 0; y < STAGE_Y; y++)
            {
                for (int z = 0; z < STAGE_Z; z++)
                {
                    gimmickNumArray[y, x, z] = stage[y, x, z];
                }
            }
        }
    }

    // ターン数の取得
    public int getStageTurnNum()
    {
        return turnNum;
    }

    // スタート位置の取得
    public Vector3 getStartPosition()
    {
        Vector3 startPosition = new Vector3(0, 0, 0);

        for (int x = 0; x < STAGE_X; x++)
        {
            for (int y = 0; y < STAGE_Y; y++)
            {
                for (int z = 0; z < STAGE_Z; z++)
                {
                    gimmick = 0;            // 配列の数字
                    gimmickPattern = 0;     // ギミックの種類
                    gimmickDirection = 0;   // ギミックの向き
                    gimmickStartTurn = 0;   // ギミックの開始ターン

                    gimmick = gimmickNumArray[y, x, z]; // 配列の数字を一時的に保存する
                    gimmickDirection = gimmick / 10000; // 配列の数字を一万で割りギミックの向きを求める
                    gimmick = gimmick % 10000;          // 配列の数字を一万で割った余りを入れる
                    gimmickPattern = gimmick / 100;     // 配列の数字を百で割りギミックの種類を求める
                    gimmick = gimmick % 100;            // 配列の数字を百で割った余りを入れる
                    gimmickStartTurn = gimmick;         // ギミックの開始ターンを入れる

                    if (gimmickPattern == START)
                    {
                        startPosition = new Vector3(x, y - 0.5f, z);
                    }
                }
            }
        }
        return startPosition;
    }

    public int getStartArrayPosition(char c)
    {
        int arrayPos = 0;

        for (int x = 0; x < STAGE_X; x++)
        {
            for (int y = 0; y < STAGE_Y; y++)
            {
                for (int z = 0; z < STAGE_Z; z++)
                {
                    gimmick = 0;            // 配列の数字
                    gimmickPattern = 0;     // ギミックの種類
                    gimmickDirection = 0;   // ギミックの向き
                    gimmickStartTurn = 0;   // ギミックの開始ターン

                    gimmick = gimmickNumArray[y, x, z]; // 配列の数字を一時的に保存する
                    gimmickDirection = gimmick / 10000; // 配列の数字を一万で割りギミックの向きを求める
                    gimmick = gimmick % 10000;          // 配列の数字を一万で割った余りを入れる
                    gimmickPattern = gimmick / 100;     // 配列の数字を百で割りギミックの種類を求める
                    gimmick = gimmick % 100;            // 配列の数字を百で割った余りを入れる
                    gimmickStartTurn = gimmick;         // ギミックの開始ターンを入れる

                    if (gimmickPattern == START)
                    {
                        switch (c)
                        {
                            case 'x': arrayPos = x; break;
                            case 'y': arrayPos = y; break;
                            case 'z': arrayPos = z; break;
                        }
                    }
                }
            }
        }
        return arrayPos;
    }

    // ギミックの向きを取得
    Vector3 getGimmickDirection(int directionPattern)
    {
        Vector3 direction = new Vector3(0, 0, 0);

        Vector3 direction1 = new Vector3(0, 0, 0);
        Vector3 direction2 = new Vector3(0, 90, 0);
        Vector3 direction3 = new Vector3(0, 180, 0);
        Vector3 direction4 = new Vector3(0, 270, 0);

        switch (directionPattern)
        {
            case 1: direction = direction1; break;
            case 2: direction = direction2; break;
            case 3: direction = direction3; break;
            case 4: direction = direction4; break;
        }

        return direction;
    }

    // 移動可能判定
    public bool MovePossibleDecision(Player alice, Player.MoveDirection direction)
    {
        bool moveDirectionflag = false;
        bool moveDirectionDownflag = false;

        int posX = alice.arrayPosX;                     // 配列上の座標Ｘ
        int posY = alice.arrayPosY;                     // 配列上の座標Ｙ
        int posZ = alice.arrayPosZ;                     // 配列上の座標Ｚ
        Player.PlayerAngle angle = alice.playerAngle;   // アリスの向き

        // アリスがステージ外にいる場合
        if((posY == 0) || (posX == 0) || (posX == 10) || (posZ == 0) || (posZ == 10))
        {
            return false;
        }
        else
        {
            // 移動方向が
            switch(direction)
            {
                // 前なら
                case Player.MoveDirection.FRONT:
                    // アリスの向きが
                    switch(angle)
                    {
                        // 前なら
                        case Player.PlayerAngle.FRONT:
                            moveDirectionflag = 
                    }
            }
        }
    }

    // 横判定
    bool BesideDicision(int gimmick, int posX, int posY, int posZ)
    {
        bool flag = false;

        switch(gimmick)
        {
            // 移動できる
            case NONE:      // 何も無い
            case START:     // スタート地点
            case GOAL:      // ゴール地点
                flag = true;
                break;

            // 移動できない
            case BLOCK:     // ブロック
            case ENEMY:     // 敵
                flag = false;
                break;
        }

        return flag;
    }

    // 横下判定
    bool BesideDownDicision(int gimmick, int posX, int posY, int posZ)
    {
        bool flag = false;

        switch (gimmick)
        {
            // 移動できる
            case NONE:      // 何も無い
            case START:     // スタート地点
            case GOAL:      // ゴール地点
            case BLOCK:     // ブロック
            case ENEMY:     // 敵
                flag = true;
                break;
        }

        return flag;
    }
}